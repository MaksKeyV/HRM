<!DOCTYPE html>
<html lang = "ru">
<head>
    <meta charset = "UTF-8">
    <title>HRM — Сотрудники</title>
 
    <style>
        /* Стили таблиц */
        table {width: 90%; margin: 20px auto; border-collapse: collapse;}
        th, td {border: 1px solid #444; padding: 8px;}
        th {background: #eee;}

         /* Панель фильтров */
        .filters {text-align: center; margin: 20px;}
        select, input {margin: 0 5px; padding: 3px 5px;}
        button {padding: 5px 10px; cursor: pointer;}
    </style>
</head>
<body>

<h2 style = "text-align:center">Сотрудники компании</h2>

<!-- Кнопки перехода к справочникам -->
<div style="text-align:center; margin-bottom: 20px;">
    <button onclick = "location.href = 'departments.html'">Список отделов</button>
    <button onclick = "location.href = 'positions.html'">Список должностей</button>
</div>

<!-- Панель фильтров -->
<div class = "filters">
    <select id = "departmentFilter"></select>
    <select id = "positionFilter"></select>
    <input type = "date" id = "hireFrom">
    <input type = "date" id = "hireTo">
</div>

<!-- Таблица сотрудников -->
<table id = "employeesTable">
    <thead>
        <tr>
            <th>ФИО</th>
            <th>Отдел</th>
            <th>Должность</th>
            <th>Дата приёма</th>
            <th>Текущая зарплата</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>



<script>

const API = "http://127.0.0.1:8000";

// Функция открывает страницу истории зарплат выбранного сотрудника
// Параметры:
//   id — ID сотрудника
//   first — имя сотрудника
//   last — фамилия сотрудника
// Возвращаемое значение: отсутствует
function openHistory(id, first, last) 
{
    // Формируем URL и переводим браузер на другую страницу
    window.location.href = `history_salary.html?employee=${id}&first=${first}&last=${last}`;
}

// Функция преобразует дату из формата YYYY-MM-DD в DD.MM.YYYY
// Параметры: dateString — строка даты
// Возвращаемое значение: строка формата "DD.MM.YYYY"
function formatDate(dateString) 
{
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, "0");
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const year = date.getFullYear();
    return `${day}.${month}.${year}`;    // Составляем строку в нужном формате
}


// Функция загружает список отделов
// Параметры: отсутствуют
// Возвращаемое значение: отсутствует
async function loadDepartments() 
{
    const resp = await fetch(`${API}/departments`);
    const data = await resp.json();
    const sel = document.getElementById("departmentFilter");
    sel.innerHTML = "<option value=''>Все отделы</option>";

     // Заполняем названиями отделов
    data.forEach(d => 
    {
        const o = document.createElement("option");
        o.value = d.id;
        o.textContent = d.name;
        sel.appendChild(o);
    });
}


// Функция загружает список должностей
// Параметры: отсутствуют
// Возвращаемое значение: отсутствует
async function loadPositions() 
{
    const resp = await fetch(`${API}/positions`);
    const data = await resp.json();

    const sel = document.getElementById("positionFilter");
    sel.innerHTML = "<option value=''>Все должности</option>";

      // Заполняем названиями должностей
    data.forEach(p => 
    {
        const o = document.createElement("option");
        o.value = p.id;
        o.textContent = p.name;
        sel.appendChild(o);
    });
}


// Функция открывает страницу истории зарплат выбранного сотрудника
// Параметры:
//   id — id сотрудника
//   first — имя сотрудника
//   middle — отчество сотрудника
//   last — фамилия сотрудника
// Возвращаемое значение: отсутствует
function openHistory(id, first, middle, last) 
{
    // Формируем URL для страницы истории зарплат с передачей id, имени, отчества и фамилии
    window.location.href = `history_salary.html?employee=${id}&first=${first}&middle=${middle || ''}&last=${last}`;
}


// Функция загружает список сотрудников
// Параметры: отсутствуют
// Возвращаемое значение: отсутствует
async function loadEmployees() 
{
    // Получаем значения фильтров
    const dept = document.getElementById("departmentFilter").value;
    const pos = document.getElementById("positionFilter").value;
    const hireFrom = document.getElementById("hireFrom").value;
    const hireTo = document.getElementById("hireTo").value;

    // Формируем URL запроса с параметрами
    let url = `${API}/employees?`;

    if (dept) url += `department_id=${dept}&`;
    if (pos) url += `position_id=${pos}&`;
    if (hireFrom) url += `hire_date_from=${hireFrom}&`;
    if (hireTo) url += `hire_date_to=${hireTo}&`;

    const resp = await fetch(url);
    const data = await resp.json();

    const tbody = document.querySelector("#employeesTable tbody");
    tbody.innerHTML = "";

    data.forEach(emp => 
    {
        const row = document.createElement("tr");
        
        // При клике — переход к истории зарплат сотрудника
        row.onclick = () => openHistory(emp.id, emp.first_name, emp.middle_name, emp.last_name);
        
        // Заполняем ячейки данными
        row.innerHTML = 
        `
            <td>${emp.last_name} ${emp.first_name}${emp.middle_name ? ' ' + emp.middle_name : ''}</td>
            <td>${emp.department.name}</td>
            <td>${emp.position.name}</td>
            <td>${formatDate(emp.hire_date)}</td>
            <td>${emp.current_salary ? emp.current_salary.toLocaleString("ru-RU") + " ₽" : "—"}</td>
        `;
        tbody.appendChild(row);
    });
}


// Основная функция инициализации страницы:
//   — загружает отделы
//   — загружает должности
//   — загружает сотрудников
//   — активирует фильтры
// Параметры: отсутствуют
// Возвращаемое значение: отсутствует
async function init() 
{
    await loadDepartments();
    await loadPositions();
    await loadEmployees();

    // Включаем фильтрацию
    document.getElementById("departmentFilter").addEventListener("change", loadEmployees);
    document.getElementById("positionFilter").addEventListener("change", loadEmployees);
    document.getElementById("hireFrom").addEventListener("change", loadEmployees);
    document.getElementById("hireTo").addEventListener("change", loadEmployees);
}


// Инициализация страницы
window.onload = init;

</script>

</body>
</html>
